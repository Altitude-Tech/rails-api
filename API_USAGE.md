# API Usage
The below documents the available actions of the API. All requests and responses will be in JSON format. The route for each action below only includes the path, the full URL will vary depending on whether the API is running in development or production mode. The development URL will either be `http://localhost:3000/$path` or `http://$IP:3000/$path`, with the production URL being `http://sensly.io/$path`.

## Errors
If an error occurs as a result of a request or generating a response, an error response will be returned in the following format:
```json
{
	"error": "$code",
	"message": "$message",
	"user_message": "$user_message",
	"status": "$status"
}
```

- `error` will contain a unique code identifying the type of error that occurred.
- `message` will contain a message describing the error. This message is always present and is aimed at explaining the error to a developer.
- `user_message` contains a messages describing the error, but is designed to explain the error to an end user. This is not always present, but if a response contains one it should be used to describe the error to an end user. If it is not present, the `message` should be used instead.
- `status` contains the HTTP error code. This will be 400 for bad client request or 500 for an internal server error. Please report any internal errors to the [issue tracker](https://github.com/Altitude-Tech/rails-api/issues).

## Tokens
Many of the actions made available by the API require a CSRF token. If a token is required, the request body for a particular action will include a `token` key. This token can be obtained by sending a POST request to `/api/tokens`. POST and PUT requests require tokens, while GET requests do not. Tokens obtained through this method will expire 10 minutes after creation or when they are used, irrespective of whether the request resulted in an error or not.

The response to this request if no errors occur will be:
```json
{
	"token": "$token"
}
```

## Users
### Creating a new account
To create an account, send the following to `/api/users` with a POST request:
```json
{
	"name": "$name",
	"email": "$email",
	"password": "$password",
	"token": "$token"
}
```

The response to this request if no errors occur will be:
```json
{
	"result": "success"
}
```

### Logging in
To log in via the API, send the following to `/api/users/login` using a POST request:
```json
{
	"email": "$email",
	"password": "$password",
	"token": "$token"
}
```

The response to this request if no errors occur will be:
```json
{
	"result": "success"
}
```

### Retrieving user details
To get a user's details, send a GET request to `/api/users`. This action requires a user to be logged in and will return the details of the currently logged in user.

The response to this request if no errors occur will be:
```json
{
	"name": "$name",
	"password": "$password"
}
```

### Updating user details
To update a user's details, send the following to `/api/users` as a PUT request. This requires a user to be logged in.
```json
{
	"name": "$new_name",
	"$token": "$token"
}
```

The attributes of a user that can currently be updated are:
- name

The response to this request if no errors occur will be:
```json
{
	"name": "$new_name"
}
```

### Resetting a password
*This describes an action that is under development and may not work at this time.*

### Logging out
To log out via the API, send a POST request to `/api/users/logout`.

The response to this request if no errors occur will be:
```json
{
	"result": "success"
}
```

## Groups
### Creating a group

### Adding users to a group

### Getting data about a group

## Devices
### Registering a device
Before a device can be registered, a new device id must be generated. See [Creating a new device id](#creating-a-new-device-id) for how to do this.

To register a device, send to following to `/api/devices` as a POST request:
```json
{
	"identity": "$device_id"
}
```

This action requires a user to be logged in and be a member of a group.

The response to this request if no errors occur will be:
```json
{
	"identity": "$identity",
	"token": "$token"
}
```

Note that the `token` in this case is different to a [CSRF token](#tokens) and essentially acts as the device's password. It should be used when creating a new [data entry](#creating-a-new-data-entry) and does not expire after use.

## Data
### Creating a new data entry
To create a new data entry, send the following to `/api/data` as a POST request:
```json
{
	"identity": "$device_id",
	"token": "$token",
	"sensor_type": "$sensor_type",
	"sensor_error": "$sensor_error",
	"sensor_data": "$sensor_data",
	"humidity": "$humidity",
	"pressure": "$pressure",
	"temperature": "$temperature",
	"log_time": "$time"
}
```

- `token` is not a CSRF token, and is instead the token from the response when registering the device.
- `sensor_type` is a SHA1 deigest as a hexadecimal string. It can be generated by hashing the sensor type which is one of `mq2`, `mq7`, or `mq135`.
- `log_time` is the time the reading was taken in unix time.

The response to this request if no errors occur will be:
```json
{
	"result": "success"
}
```

### Retrieving a device's data

## Staff actions
All staff API actions require the user to be logged in as a staff member.

### Users
#### Adding a user to staff
*This describes an action that is under not yet implemented.*

To make an existing user a staff member, send to following to `/api/staff/users/add` as a POST request:
```json
{
	"email": "$email",
	"token": "$token"
}
```

- `email` is the email address of the user being made a staff member.

#### Removing a user from staff
*This describes an action that is under not yet implemented.*

To remove the staff flag from a user account, send to following to `/api/staff/users/remove` as a POST request:
```json
{
	"email": "$email",
	"token": "$token"
}
```

- `email` is the email address of the user being made a staff member. Note that you cannot remove the staff flag from your own account.

### Devices
#### Creating a new device id
Before a device can be registered, a new identity for it must be generated. To do this, send a POST request to `api/staff/devices` with the following:
```json
{
	"type": "$type"
}
```

`type` is a SHA1 digest as a hexadecimal string. It can be generated by hashing the type name which is one of `main`, `hat`, `go` or `pro`.

The response to this request if no errors occur will be:
```json
{
	"identity": "$new_device_id"
}
```
